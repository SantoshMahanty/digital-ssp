<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ad Request Tester - Digital-SSP</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon">DS</div>
        <div>
          <h1>Digital-SSP</h1>
          <p style="font-size: 0.875rem; color: var(--text-secondary);">Ad Request Tester</p>
        </div>
      </div>
      <nav>
        <a href="index.html" class="active">Ad Tester</a>
        <a href="inspector.html">Inspector</a>
        <a href="dashboard.html">Dashboard</a>
      </nav>
    </div>
  </header>

  <div class="container">
    <div class="grid grid-2">
      <!-- Request Form -->
      <div class="card">
        <div class="card-header">
          <div>
            <h2 class="card-title">üéØ Test Ad Request</h2>
            <p class="card-subtitle">Configure and send ad requests to the delivery engine</p>
          </div>
        </div>

        <form id="adRequestForm">
          <div class="form-group">
            <label for="apiUrl">API Endpoint</label>
            <input type="text" id="apiUrl" value="http://localhost:8000/ad" placeholder="http://localhost:8000/ad">
            <div class="form-help">FastAPI ad decisioning endpoint</div>
          </div>

          <div class="form-group">
            <label for="adUnit">Ad Unit Code *</label>
            <input type="text" id="adUnit" value="news/home/hero" placeholder="e.g., news/home/hero" required>
            <div class="form-help">The ad unit path/code from your inventory</div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="geo">Geo/Country *</label>
              <select id="geo" required>
                <option value="US">United States</option>
                <option value="CA">Canada</option>
                <option value="UK">United Kingdom</option>
                <option value="DE">Germany</option>
                <option value="FR">France</option>
                <option value="JP">Japan</option>
                <option value="AU">Australia</option>
              </select>
            </div>

            <div class="form-group">
              <label for="device">Device Type *</label>
              <select id="device" required>
                <option value="desktop">Desktop</option>
                <option value="mobile">Mobile</option>
                <option value="tablet">Tablet</option>
                <option value="ctv">CTV</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="sizes">Ad Sizes (JSON) *</label>
            <textarea id="sizes" required>[{"w": 970, "h": 250}, {"w": 728, "h": 90}]</textarea>
            <div class="form-help">Array of size objects with width and height</div>
          </div>

          <div class="form-group">
            <label for="keyValues">Key-Values (JSON)</label>
            <textarea id="keyValues">{"category": "news", "logged_in": "true"}</textarea>
            <div class="form-help">Targeting key-value pairs</div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="userId">User ID</label>
              <input type="text" id="userId" placeholder="u1234" value="test-user-001">
              <div class="form-help">For frequency capping</div>
            </div>

            <div class="form-group">
              <label for="viewportW">Viewport Width</label>
              <input type="number" id="viewportW" placeholder="1920" value="1920">
              <div class="form-help">For responsive size mapping</div>
            </div>
          </div>

          <button type="submit" class="btn btn-primary" id="submitBtn">
            <span>üöÄ Send Ad Request</span>
          </button>
        </form>
      </div>

      <!-- Response Display -->
      <div class="card">
        <div class="card-header">
          <div>
            <h2 class="card-title">üìä Response</h2>
            <p class="card-subtitle">Ad decisioning result</p>
          </div>
          <button class="btn btn-secondary" id="clearBtn" style="display: none;">Clear</button>
        </div>

        <div id="responseContainer">
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <div class="empty-state-text">No request sent yet</div>
            <p style="font-size: 0.875rem;">Fill out the form and click "Send Ad Request" to see results</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Requests History -->
    <div class="card">
      <div class="card-header">
        <div>
          <h2 class="card-title">üìú Request History</h2>
          <p class="card-subtitle">Recent ad requests and responses</p>
        </div>
        <button class="btn btn-secondary" id="clearHistoryBtn" style="display: none;">Clear History</button>
      </div>
      <div id="historyContainer">
        <div class="empty-state">
          <div class="empty-state-icon">üïê</div>
          <div class="empty-state-text">No history yet</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL_KEY = 'dsp_api_url';
    const HISTORY_KEY = 'dsp_request_history';
    const MAX_HISTORY = 10;

    // Load saved API URL
    document.getElementById('apiUrl').value = localStorage.getItem(API_URL_KEY) || 'http://localhost:8000/ad';

    // Load history
    loadHistory();

    // Form submission
    document.getElementById('adRequestForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const apiUrl = document.getElementById('apiUrl').value;
      const submitBtn = document.getElementById('submitBtn');
      const responseContainer = document.getElementById('responseContainer');

      // Save API URL
      localStorage.setItem(API_URL_KEY, apiUrl);

      // Parse JSON fields
      let sizes, keyValues;
      try {
        sizes = JSON.parse(document.getElementById('sizes').value);
        keyValues = JSON.parse(document.getElementById('keyValues').value || '{}');
      } catch (err) {
        showError('Invalid JSON in sizes or key-values: ' + err.message);
        return;
      }

      // Build request payload
      const payload = {
        adUnit: document.getElementById('adUnit').value,
        sizes: sizes,
        kv: keyValues,
        geo: document.getElementById('geo').value,
        device: document.getElementById('device').value,
        userId: document.getElementById('userId').value || null,
        viewportW: parseInt(document.getElementById('viewportW').value) || null
      };

      // Show loading
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading"></span> <span>Sending...</span>';
      
      try {
        const startTime = Date.now();
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });

        const latency = Date.now() - startTime;
        const data = await response.json();

        if (response.ok) {
          showSuccess(data, latency, payload);
          saveToHistory({ payload, response: data, status: 'success', latency, timestamp: new Date().toISOString() });
        } else {
          showError(`Error ${response.status}: ${data.detail || 'Unknown error'}`, data);
          saveToHistory({ payload, response: data, status: 'error', latency, timestamp: new Date().toISOString() });
        }
      } catch (err) {
        showError('Network error: ' + err.message);
        saveToHistory({ payload, response: { error: err.message }, status: 'network_error', timestamp: new Date().toISOString() });
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span>üöÄ Send Ad Request</span>';
      }
    });

    function showSuccess(data, latency, request) {
      const container = document.getElementById('responseContainer');
      document.getElementById('clearBtn').style.display = 'block';

      container.innerHTML = `
        <div class="alert alert-success">
          <div>
            <strong>‚úÖ Ad Delivered Successfully</strong>
            <div style="margin-top: 0.5rem; font-size: 0.875rem;">
              Latency: ${latency}ms | Request ID: ${data.req_id || 'N/A'}
            </div>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Source</div>
            <div class="stat-value" style="font-size: 1.5rem;">${data.source || 'N/A'}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Price (CPM)</div>
            <div class="stat-value" style="font-size: 1.5rem;">$${(data.price || 0).toFixed(2)}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Line Item</div>
            <div class="stat-value" style="font-size: 1.25rem;">${data.line_item_id || 'N/A'}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Creative</div>
            <div class="stat-value" style="font-size: 1.25rem;">${data.creative_id || 'N/A'}</div>
          </div>
        </div>

        <h3 style="margin-bottom: 1rem;">üì¶ Full Response</h3>
        <div class="code-block">
          <pre>${JSON.stringify(data, null, 2)}</pre>
        </div>

        ${data.req_id ? `
        <div style="margin-top: 1rem;">
          <a href="inspector.html?reqId=${data.req_id}" class="btn btn-primary">
            üîç View in Inspector
          </a>
        </div>
        ` : ''}
      `;
    }

    function showError(message, data = null) {
      const container = document.getElementById('responseContainer');
      document.getElementById('clearBtn').style.display = 'block';

      container.innerHTML = `
        <div class="alert alert-error">
          <div>
            <strong>‚ùå Request Failed</strong>
            <div style="margin-top: 0.5rem;">${message}</div>
          </div>
        </div>
        ${data ? `
        <h3 style="margin-bottom: 1rem;">Error Details</h3>
        <div class="code-block">
          <pre>${JSON.stringify(data, null, 2)}</pre>
        </div>
        ` : ''}
      `;
    }

    document.getElementById('clearBtn').addEventListener('click', () => {
      document.getElementById('responseContainer').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üì≠</div>
          <div class="empty-state-text">No request sent yet</div>
        </div>
      `;
      document.getElementById('clearBtn').style.display = 'none';
    });

    function saveToHistory(entry) {
      let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      history.unshift(entry);
      history = history.slice(0, MAX_HISTORY);
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
      loadHistory();
    }

    function loadHistory() {
      const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      const container = document.getElementById('historyContainer');
      const clearBtn = document.getElementById('clearHistoryBtn');

      if (history.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üïê</div>
            <div class="empty-state-text">No history yet</div>
          </div>
        `;
        clearBtn.style.display = 'none';
        return;
      }

      clearBtn.style.display = 'block';

      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Ad Unit</th>
              <th>Status</th>
              <th>Latency</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${history.map((entry, index) => `
              <tr>
                <td>${new Date(entry.timestamp).toLocaleString()}</td>
                <td><code>${entry.payload.adUnit}</code></td>
                <td>
                  ${entry.status === 'success' 
                    ? '<span class="badge badge-success">Success</span>' 
                    : '<span class="badge badge-error">Error</span>'}
                </td>
                <td>${entry.latency ? entry.latency + 'ms' : 'N/A'}</td>
                <td>
                  <button class="btn btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;" onclick="viewHistoryDetails(${index})">
                    View
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function viewHistoryDetails(index) {
      const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      const entry = history[index];
      
      const container = document.getElementById('responseContainer');
      document.getElementById('clearBtn').style.display = 'block';

      if (entry.status === 'success') {
        showSuccess(entry.response, entry.latency, entry.payload);
      } else {
        showError(entry.response.detail || entry.response.error || 'Unknown error', entry.response);
      }

      // Scroll to response
      container.scrollIntoView({ behavior: 'smooth' });
    }

    document.getElementById('clearHistoryBtn').addEventListener('click', () => {
      if (confirm('Clear all request history?')) {
        localStorage.removeItem(HISTORY_KEY);
        loadHistory();
      }
    });
  </script>
</body>
</html>
