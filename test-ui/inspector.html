<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ad Inspector - Digital-SSP</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon">DS</div>
        <div>
          <h1>Digital-SSP</h1>
          <p style="font-size: 0.875rem; color: var(--text-secondary);">Ad Inspector</p>
        </div>
      </div>
      <nav>
        <a href="index.html">Ad Tester</a>
        <a href="inspector.html" class="active">Inspector</a>
        <a href="dashboard.html">Dashboard</a>
      </nav>
    </div>
  </header>

  <div class="container">
    <!-- Search Section -->
    <div class="card">
      <div class="card-header">
        <div>
          <h2 class="card-title">üîç Debug Ad Request</h2>
          <p class="card-subtitle">View decision traces and troubleshoot ad delivery</p>
        </div>
      </div>

      <form id="inspectorForm" class="form-row">
        <div class="form-group" style="flex: 1;">
          <label for="apiUrl">API Endpoint</label>
          <input type="text" id="apiUrl" value="http://localhost:8000/debug" placeholder="http://localhost:8000/debug">
        </div>
        <div class="form-group" style="flex: 1;">
          <label for="reqId">Request ID</label>
          <input type="text" id="reqId" placeholder="Enter request ID..." required>
        </div>
        <div class="form-group" style="align-self: flex-end;">
          <button type="submit" class="btn btn-primary" id="searchBtn">
            <span>üîé Inspect</span>
          </button>
        </div>
      </form>
    </div>

    <!-- Results Section -->
    <div id="resultsContainer">
      <div class="card">
        <div class="empty-state">
          <div class="empty-state-icon">üîç</div>
          <div class="empty-state-text">No inspection results</div>
          <p style="font-size: 0.875rem;">Enter a request ID to view decision trace details</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL_KEY = 'dsp_inspector_api_url';
    
    // Load saved API URL
    document.getElementById('apiUrl').value = localStorage.getItem(API_URL_KEY) || 'http://localhost:8000/debug';

    // Check for reqId in URL params
    const urlParams = new URLSearchParams(window.location.search);
    const reqIdParam = urlParams.get('reqId');
    if (reqIdParam) {
      document.getElementById('reqId').value = reqIdParam;
      // Auto-submit
      setTimeout(() => document.getElementById('inspectorForm').requestSubmit(), 100);
    }

    // Form submission
    document.getElementById('inspectorForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const apiUrl = document.getElementById('apiUrl').value;
      const reqId = document.getElementById('reqId').value.trim();
      const searchBtn = document.getElementById('searchBtn');
      const resultsContainer = document.getElementById('resultsContainer');

      if (!reqId) {
        alert('Please enter a request ID');
        return;
      }

      // Save API URL
      localStorage.setItem(API_URL_KEY, apiUrl);

      // Show loading
      searchBtn.disabled = true;
      searchBtn.innerHTML = '<span class="loading"></span> <span>Searching...</span>';
      
      resultsContainer.innerHTML = `
        <div class="card">
          <div style="text-align: center; padding: 2rem;">
            <div class="loading" style="width: 40px; height: 40px; border-width: 4px; margin: 0 auto 1rem;"></div>
            <p>Loading trace data...</p>
          </div>
        </div>
      `;

      try {
        const response = await fetch(`${apiUrl}/${reqId}`);
        const data = await response.json();

        if (response.ok) {
          displayTrace(data, reqId);
        } else {
          showError(`Error ${response.status}: ${data.detail || 'Request ID not found'}`);
        }
      } catch (err) {
        showError('Network error: ' + err.message);
      } finally {
        searchBtn.disabled = false;
        searchBtn.innerHTML = '<span>üîé Inspect</span>';
      }
    });

    function displayTrace(trace, reqId) {
      const resultsContainer = document.getElementById('resultsContainer');

      const hasWinner = trace.winner !== null && trace.winner !== undefined;
      const statusClass = hasWinner ? 'success' : 'error';
      const statusIcon = hasWinner ? '‚úÖ' : '‚ùå';
      const statusText = hasWinner ? 'Ad Delivered' : 'No Fill';

      resultsContainer.innerHTML = `
        <!-- Summary Card -->
        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="card-title">${statusIcon} ${statusText}</h2>
              <p class="card-subtitle">Request ID: <code>${reqId}</code></p>
            </div>
            <span class="badge badge-${statusClass}">${hasWinner ? 'Filled' : 'No Fill'}</span>
          </div>

          ${hasWinner ? `
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-label">Source</div>
                <div class="stat-value" style="font-size: 1.5rem;">${trace.winner.source || 'N/A'}</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Price (CPM)</div>
                <div class="stat-value" style="font-size: 1.5rem;">$${(trace.winner.price || 0).toFixed(2)}</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Line Item</div>
                <div class="stat-value" style="font-size: 1.25rem;">${trace.winner.line_item_id || 'N/A'}</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Creative</div>
                <div class="stat-value" style="font-size: 1.25rem;">${trace.winner.creative_id || 'N/A'}</div>
              </div>
            </div>
          ` : `
            <div class="alert alert-warning">
              <div>
                <strong>‚ö†Ô∏è No Fill Reason</strong>
                <div style="margin-top: 0.5rem; font-size: 1rem;">
                  ${trace.no_fill_reason || 'Unknown reason'}
                </div>
              </div>
            </div>
          `}
        </div>

        <!-- Decision Steps -->
        ${trace.steps && trace.steps.length > 0 ? `
          <div class="card">
            <div class="card-header">
              <div>
                <h2 class="card-title">üìã Decision Steps</h2>
                <p class="card-subtitle">Line item evaluation timeline</p>
              </div>
            </div>

            <div class="timeline">
              ${trace.steps.map(step => {
                const isFilter = step.step === 'filter';
                const stepClass = isFilter ? 'error' : 'success';
                return `
                  <div class="timeline-item ${stepClass}">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                      <div>
                        <strong>${step.step}</strong>
                        ${step.detail ? `<span style="color: var(--text-secondary);"> - ${step.detail}</span>` : ''}
                        ${step.data ? `<div style="margin-top: 0.25rem;"><code>${JSON.stringify(step.data)}</code></div>` : ''}
                      </div>
                      <span class="badge badge-${stepClass}">${isFilter ? 'Filtered' : 'Passed'}</span>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        ` : ''}

        <!-- Winner Details -->
        ${hasWinner ? `
          <div class="card">
            <div class="card-header">
              <div>
                <h2 class="card-title">üèÜ Winning Bid</h2>
                <p class="card-subtitle">Selected ad creative details</p>
              </div>
            </div>

            <div class="code-block">
              <pre>${JSON.stringify(trace.winner, null, 2)}</pre>
            </div>
          </div>
        ` : ''}

        <!-- Raw Trace Data -->
        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="card-title">üì¶ Full Trace Data</h2>
              <p class="card-subtitle">Complete decision trace object</p>
            </div>
            <button class="btn btn-secondary" onclick="copyTrace()">üìã Copy JSON</button>
          </div>

          <div class="code-block" id="fullTrace">
            <pre>${JSON.stringify(trace, null, 2)}</pre>
          </div>
        </div>

        <!-- Debugging Tips -->
        ${!hasWinner ? `
          <div class="card">
            <div class="card-header">
              <div>
                <h2 class="card-title">üí° Debugging Tips</h2>
                <p class="card-subtitle">Common no-fill causes and solutions</p>
              </div>
            </div>

            <div style="display: grid; gap: 1rem;">
              <div class="alert alert-info">
                <div>
                  <strong>üéØ Targeting Mismatch</strong>
                  <p style="margin-top: 0.5rem; font-size: 0.875rem;">
                    Check that your line items target the requested ad unit, geo, device, and key-values.
                  </p>
                </div>
              </div>

              <div class="alert alert-info">
                <div>
                  <strong>üìä Pacing Throttled</strong>
                  <p style="margin-top: 0.5rem; font-size: 0.875rem;">
                    Line item may be pacing to meet delivery goals. Check delivered vs. booked impressions.
                  </p>
                </div>
              </div>

              <div class="alert alert-info">
                <div>
                  <strong>üí∞ Floor Price</strong>
                  <p style="margin-top: 0.5rem; font-size: 0.875rem;">
                    Bids may be below the effective floor price for this geo/device combination.
                  </p>
                </div>
              </div>

              <div class="alert alert-info">
                <div>
                  <strong>üö´ Frequency Cap</strong>
                  <p style="margin-top: 0.5rem; font-size: 0.875rem;">
                    User may have reached the frequency cap limit for eligible line items.
                  </p>
                </div>
              </div>
            </div>
          </div>
        ` : ''}
      `;
    }

    function showError(message) {
      const resultsContainer = document.getElementById('resultsContainer');
      resultsContainer.innerHTML = `
        <div class="card">
          <div class="alert alert-error">
            <div>
              <strong>‚ùå Inspection Failed</strong>
              <div style="margin-top: 0.5rem;">${message}</div>
            </div>
          </div>
          <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <div class="empty-state-text">Request ID not found</div>
            <p style="font-size: 0.875rem;">The request may have expired or the ID is incorrect</p>
          </div>
        </div>
      `;
    }

    function copyTrace() {
      const traceText = document.getElementById('fullTrace').innerText;
      navigator.clipboard.writeText(traceText).then(() => {
        alert('‚úÖ Trace data copied to clipboard!');
      }).catch(err => {
        alert('‚ùå Failed to copy: ' + err.message);
      });
    }
  </script>
</body>
</html>
