{% extends "base.html" %}

{% block title %}Reporting & Analytics - Digital-SSP{% endblock %}

{% block content %}
<style>
.tab-navigation {
    display: flex;
    gap: 10px;
    border-bottom: 2px solid #e0e0e0;
    margin-bottom: 30px;
}

.tab-btn {
    padding: 12px 20px;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s;
}

.tab-btn:hover {
    background: #f5f5f5;
    color: #2196F3;
}

.tab-btn.active {
    color: #2196F3;
    border-bottom-color: #2196F3;
}

.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.kpi-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
}

.kpi-value {
    font-size: 32px;
    font-weight: bold;
    color: #2196F3;
    margin-bottom: 5px;
}

.kpi-label {
    color: #666;
    font-size: 14px;
}

.kpi-change {
    font-size: 12px;
    margin-top: 5px;
}
</style>

<div class="page-header">
    <h1>ðŸ“ˆ Reporting & Analytics</h1>
    <p>View delivery performance, yield metrics, and comprehensive analytics</p>
</div>

<div class="tab-navigation">
    <button class="tab-btn active" onclick="switchTab(event, 'delivery')">Delivery Report</button>
    <button class="tab-btn" onclick="switchTab(event, 'yield')">Yield Report</button>
    <button class="tab-btn" onclick="switchTab(event, 'dimensions')">Dimensional Analysis</button>
    <button class="tab-btn" onclick="switchTab(event, 'scheduling')">Report Scheduling</button>
</div>

<!-- DELIVERY REPORT Section -->
<div id="delivery" class="tab-content" style="display: block;">
    <h2>Delivery Performance</h2>
    
    <!-- Date Range Filter -->
    <div class="card" style="margin-bottom: 20px;">
        <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
            <label>Date Range:
                <input type="date" id="startDate" style="padding: 8px;">
                to
                <input type="date" id="endDate" style="padding: 8px;">
            </label>
            <button class="btn btn-primary" onclick="updateReport()">Update Report</button>
            <button class="btn btn-outline" onclick="exportReport('csv')">ðŸ“¥ Export CSV</button>
            <button class="btn btn-outline" onclick="exportReport('pdf')">ðŸ“¥ Export PDF</button>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-value">11.3M</div>
            <div class="kpi-label">Total Impressions</div>
            <div class="kpi-change">ðŸ“ˆ +12% vs previous period</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value">$127.5K</div>
            <div class="kpi-label">Total Revenue</div>
            <div class="kpi-change">ðŸ“ˆ +8.5% vs previous period</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value">$11.27</div>
            <div class="kpi-label">Average CPM</div>
            <div class="kpi-change">ðŸ“‰ -0.8% vs previous period</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value">89.2%</div>
            <div class="kpi-label">Booked %</div>
            <div class="kpi-change">âœ“ On target (goal: 85%+)</div>
        </div>
    </div>

    <!-- Delivery by Order -->
    <div class="card">
        <h3>Delivery by Order</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Order Name</th>
                        <th>Booked</th>
                        <th>Delivered</th>
                        <th>Remaining</th>
                        <th>Delivery %</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Premium Brand Q1 2026</td>
                        <td>10,000,000</td>
                        <td>8,950,000</td>
                        <td>1,050,000</td>
                        <td>89.5%</td>
                        <td><span class="badge badge-success">On Pace</span></td>
                        <td><button class="btn btn-sm btn-outline">Details</button></td>
                    </tr>
                    <tr>
                        <td>Seasonal Campaign Jan</td>
                        <td>2,500,000</td>
                        <td>2,485,230</td>
                        <td>14,770</td>
                        <td>99.4%</td>
                        <td><span class="badge badge-success">Complete</span></td>
                        <td><button class="btn btn-sm btn-outline">Details</button></td>
                    </tr>
                    <tr>
                        <td>Network Sponsorship</td>
                        <td>5,000,000</td>
                        <td>3,210,450</td>
                        <td>1,789,550</td>
                        <td>64.2%</td>
                        <td><span class="badge badge-warning">Behind Pace</span></td>
                        <td><button class="btn btn-sm btn-outline">Details</button></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- YIELD REPORT Section -->
<div id="yield" class="tab-content" style="display: none;">
    <h2>Yield & Revenue Analysis</h2>

    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-value">$127.5K</div>
            <div class="kpi-label">Total Revenue</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value">$11.27</div>
            <div class="kpi-label">Average CPM</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value">$144.2K</div>
            <div class="kpi-label">Forecasted Revenue</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value">88.5%</div>
            <div class="kpi-label">Realization Rate</div>
        </div>
    </div>

    <div class="card">
        <h3>Revenue by SSP</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>SSP</th>
                        <th>Impressions</th>
                        <th>Revenue</th>
                        <th>Avg CPM</th>
                        <th>% of Total</th>
                        <th>Trend</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Google Ad Exchange</td>
                        <td>5,800,000</td>
                        <td>$68,750</td>
                        <td>$11.85</td>
                        <td>53.8%</td>
                        <td>ðŸ“ˆ +15%</td>
                    </tr>
                    <tr>
                        <td>Rubicon Project</td>
                        <td>3,200,000</td>
                        <td>$35,200</td>
                        <td>$11.00</td>
                        <td>27.6%</td>
                        <td>ðŸ“‰ -3%</td>
                    </tr>
                    <tr>
                        <td>OpenX</td>
                        <td>2,100,000</td>
                        <td>$21,840</td>
                        <td>$10.40</td>
                        <td>17.1%</td>
                        <td>ðŸ“ˆ +8%</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- DIMENSIONAL ANALYSIS Section -->
<div id="dimensions" class="tab-content" style="display: none;">
    <h2>Dimensional Analysis</h2>

    <div class="card">
        <h3>Performance by Geography</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Country</th>
                        <th>Impressions</th>
                        <th>Revenue</th>
                        <th>Avg CPM</th>
                        <th>Fill Rate</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>United States</td>
                        <td>7,200,000</td>
                        <td>$91,200</td>
                        <td>$12.67</td>
                        <td>94.2%</td>
                    </tr>
                    <tr>
                        <td>Canada</td>
                        <td>1,800,000</td>
                        <td>$19,800</td>
                        <td>$11.00</td>
                        <td>87.5%</td>
                    </tr>
                    <tr>
                        <td>United Kingdom</td>
                        <td>1,500,000</td>
                        <td>$14,250</td>
                        <td>$9.50</td>
                        <td>82.3%</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="card" style="margin-top: 20px;">
        <h3>Performance by Device</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Device Type</th>
                        <th>Impressions</th>
                        <th>Revenue</th>
                        <th>Avg CPM</th>
                        <th>CTR</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Desktop</td>
                        <td>5,200,000</td>
                        <td>$63,400</td>
                        <td>$12.19</td>
                        <td>0.84%</td>
                    </tr>
                    <tr>
                        <td>Mobile</td>
                        <td>5,100,000</td>
                        <td>$51,000</td>
                        <td>$10.00</td>
                        <td>1.42%</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- REPORT SCHEDULING Section -->
<div id="scheduling" class="tab-content" style="display: none;">
    <h2>Scheduled Reports</h2>

    <button class="btn btn-primary" onclick="openScheduleModal()">+ Schedule Report</button>

    <div class="card" style="margin-top: 20px;">
        <h3>Existing Scheduled Reports</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Report Name</th>
                        <th>Type</th>
                        <th>Schedule</th>
                        <th>Recipients</th>
                        <th>Last Sent</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Weekly Performance Summary</td>
                        <td>Delivery & Yield</td>
                        <td>Every Monday 9:00 AM</td>
                        <td>5 recipients</td>
                        <td>Jan 6, 2026</td>
                        <td><span class="badge badge-success">Active</span></td>
                    </tr>
                    <tr>
                        <td>Daily Delivery Report</td>
                        <td>Delivery Only</td>
                        <td>Daily 8:00 AM</td>
                        <td>3 recipients</td>
                        <td>Jan 5, 2026</td>
                        <td><span class="badge badge-success">Active</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Schedule Report Modal -->
<div id="scheduleModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeScheduleModal()">&times;</span>
        <h2>Schedule Report</h2>
        <form id="scheduleForm" onsubmit="handleScheduleReport(event)">
            <div class="form-group">
                <label>Report Name *</label>
                <input type="text" name="report_name" required placeholder="Weekly Performance Summary">
            </div>
            <div class="form-group">
                <label>Report Type *</label>
                <select name="report_type" required>
                    <option value="delivery">Delivery Report</option>
                    <option value="yield">Yield Report</option>
                </select>
            </div>
            <div class="form-group">
                <label>Schedule *</label>
                <select name="schedule" required>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                </select>
            </div>
            <div class="form-group">
                <label>Email Recipients *</label>
                <textarea name="recipients" required placeholder="one@example.com, two@example.com" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Create Scheduled Report</button>
        </form>
    </div>
</div>

<script>
function switchTab(event, tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabName).style.display = 'block';
    event.target.classList.add('active');
}

function openScheduleModal() { document.getElementById('scheduleModal').style.display = 'block'; }
function closeScheduleModal() { document.getElementById('scheduleModal').style.display = 'none'; }

function updateReport() {
    alert('Updating report with selected date range...');
}

function exportReport(format) {
    alert(`Exporting report as ${format.toUpperCase()}...`);
}

function handleScheduleReport(event) {
    event.preventDefault();
    const data = Object.fromEntries(new FormData(event.target));
    
    fetch('/api/reports/schedule', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(result => {
        if (result.success) {
            alert('âœ“ Report scheduled successfully!');
            closeScheduleModal();
            location.reload();
        } else {
            alert('âœ— Error: ' + result.message);
        }
    })
    .catch(err => alert('âœ— Error: ' + err.message));
}

window.onclick = function(event) {
    const modal = document.getElementById('scheduleModal');
    if (event.target == modal) modal.style.display = 'none';
}
</script>
{% endblock %}
        <button class="btn btn-secondary">Download CSV</button>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Total Impressions</div>
        <div class="stat-value">1.2M</div>
        <div class="stat-change positive">â†‘ 12%</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Total Clicks</div>
        <div class="stat-value">24.5K</div>
        <div class="stat-change positive">â†‘ 8%</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Click-Through Rate</div>
        <div class="stat-value">2.04%</div>
        <div class="stat-change negative">â†“ 0.3%</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Total Revenue</div>
        <div class="stat-value">$48.5K</div>
        <div class="stat-change positive">â†‘ 15%</div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>Performance by Order</h2>
    </div>
    
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Order Name</th>
                    <th>Impressions</th>
                    <th>Clicks</th>
                    <th>CTR</th>
                    <th>Revenue</th>
                    <th>CPM</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Premium Brand Campaign Q1</td>
                    <td>485,230</td>
                    <td>11,160</td>
                    <td>2.30%</td>
                    <td>$19,850</td>
                    <td>$40.89</td>
                </tr>
                <tr>
                    <td>Tech Partners Direct</td>
                    <td>321,450</td>
                    <td>5,785</td>
                    <td>1.80%</td>
                    <td>$13,630</td>
                    <td>$42.43</td>
                </tr>
                <tr>
                    <td>Sports Goods Network</td>
                    <td>156,789</td>
                    <td>2,352</td>
                    <td>1.50%</td>
                    <td>$6,280</td>
                    <td>$40.05</td>
                </tr>
                <tr>
                    <td>Brand Direct Campaign</td>
                    <td>235,412</td>
                    <td>5,248</td>
                    <td>2.23%</td>
                    <td>$8,740</td>
                    <td>$37.12</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
